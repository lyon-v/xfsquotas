## XFS Quotas 管理工具 整体架构设计文档 (High-Level)



### 1. 概述



#### 1.1. 项目愿景

本项目的愿景是为 Linux 系统管理员提供一个简单、直观且可靠的工具，用于管理 XFS 文件系统上**基于目录**的磁盘配额。它旨在将 XFS 底层复杂的“项目配额（Project Quota）”机制抽象成一个用户友好的、面向目录的配额管理模型。

#### 1.2. 解决的核心问题

XFS 的原生配额是基于用户、组或“项目”的，缺乏直接对目录进行配额管理的能力。管理员若想限制某一目录的磁盘用量，必须手动执行一系列分散的操作：分配一个唯一的项目ID、将该ID与目录关联、编辑配置文件、最后再通过命令行工具设置配额。这个过程不仅繁琐，而且容易因手动误操作而导致配置不一致。

`xfsquota` 工具的设计目标就是**消除这种复杂性**，提供一个原子化的、声明式的接口来直接管理目录配ota。

#### 1.3. 设计原则

- **抽象与简化**：对用户完全隐藏“项目”和“项目ID”的底层概念。用户只需关心目录路径和配额值，工具负责处理所有底层机制的转换和管理。
- **兼容性与标准化**：工具产生的所有状态（即项目ID与目录的映射关系）都必须以符合 Linux `xfsprogs` 工具链标准的格式进行持久化。这意味着，由本工具创建的配额可以被系统的标准工具（如 `xfs_quota`, `xfs_report`）识别和管理，反之亦然，确保了系统的互操作性和透明性。
- **无状态服务**：工具本身不维护任何内部状态数据库。所有的状态信息都存储在文件系统（目录的扩展属性）和标准的系统配置文件中。这使得工具本身极其轻量，且具有高可靠性，其操作是幂等的。
- **分层与解耦**：系统架构采用清晰的层次划分，确保用户接口、业务逻辑和系统底层交互相互分离，提高了代码的可维护性和可扩展性。



### 2. 系统架构

#### 2.1. 架构视图

本系统设计为三层逻辑架构，每一层都有明确的职责边界，并通过定义好的接口进行通信。

```
+------------------------------------------------------+
|                    用户接口层                        |
|              (User Interface Layer)                  |
|          <-- 负责解析用户意图，提供交互接口 -->        |
+------------------------------------------------------+
                         ^
                         | (调用与回调)
                         v
+------------------------------------------------------+
|                     业务逻辑层                        |
|                 (Business Logic Layer)                 |
|          <-- 负责配额生命周期管理的核心决策 -->        |
+------------------------------------------------------+
                         ^
                         | (调用与回调)
                         v
+------------------------------------------------------+
|                     系统交互层                        |
|                (System Interaction Layer)              |
|         <-- 负责与操作系统内核和文件系统交互 -->       |
+------------------------------------------------------+
```



#### 2.2. 核心组件职责



1. **用户接口层 (User Interface Layer)**
   - **职责**：作为系统的入口，负责与最终用户进行交互。它的主要任务是解析用户的命令和参数（如`set`, `get`, `clean`以及配额大小），将其转换为业务逻辑层可以理解的内部请求。同时，它也负责将业务逻辑层的执行结果格式化后呈现给用户。
   - **接口**：暴露一组定义清晰的命令行动词和选项。
2. **业务逻辑层 (Business Logic Layer)**
   - **职责**：这是系统的“大脑”，负责实现所有的配额管理策略和工作流程。它编排其他层来完成一个完整的业务操作。
   - **核心功能抽象**：
     - **配额生命周期管理**：处理配额的创建、查询和销毁请求。
     - **身份标识管理**：管理一个抽象的“配额身份”（即底层的项目ID），负责其分配、查找和回收。
     - **状态持久化**：协调系统交互层，将“配额身份”与目录的关联关系持久化到标准的存储介质中，确保其在系统重启后依然有效。
3. **系统交互层 (System Interaction Layer)**
   - **职责**：作为业务逻辑层与底层操作系统之间的“适配器”或“驱动”，封装所有与系统内核及文件系统相关的底层通信细节。
   - **核心功能抽象**：
     - **文件系统查询**：提供查询文件或目录元数据（如所属挂载点、设备信息）的能力。
     - **目录属性操作**：提供为目录附加或读取“配额身份”标识的能力（对应底层的 `ioctl`）。
     - **配额控制**：提供向内核发送指令以设置或查询指定“配额身份”的资源限制的能力（对应底层的 `quotactl`）。



### 3. 关键设计决策

#### 3.1. 核心抽象模型：目录即项目 (Directory-as-a-Project)

我们选择的核心抽象是将用户可见的“目录”映射为 XFS 底层的“项目”。这是本工具能够简化操作的基石。业务逻辑层负责维护这个 1:1 的映射关系，当用户请求为一个新目录设置配额时，业务逻辑层会自动创建一个新的、唯一的“项目”身份，并将其与该目录牢固绑定。



#### 3.2. 状态管理策略：委托于系统 (Delegation to System)

我们决定不引入任何私有的数据库或状态文件来存储目录与项目ID的映射。所有状态都写入两个地方：

1. **目录的扩展属性**：项目ID直接附加在目录的inode上。这是最直接、最可靠的绑定方式。
2. **系统标准配置文件**：同步更新 `/etc/projects` 和 `/etc/projid`。

这个决策的战略优势在于**互操作性**和**鲁棒性**。即使本工具被卸载，系统的原生工具依然能完全理解并接管这些配额配置，避免了供应商锁定。



### 4. 交互流程示例 (逻辑层面)

#### 4.1. 设置新配额流程

1. **用户接口层** 接收到一个为新目录设置配额的请求。

2. 它调用 **业务逻辑层** 的“设置配额”功能。

3. **业务逻辑层** 首先请求 **系统交互层** 查询该目录的元数据。

4. **业务逻辑层** 发现该目录未绑定任何“配额身份”，于是启动“身份分配”流程，获取一个唯一的身份ID。

5. 业务逻辑层 指挥 系统交互层 执行两个关键操作：

   a. 将新分配的身份ID永久附加到目录的属性上。

   b. 向内核下发指令，为这个身份ID设置用户指定的配额限制。

6. **业务逻辑层** 同时更新标准配置文件，以确保兼容性。

7. 执行结果逐层返回，最终由 **用户接口层** 告知用户操作成功。



### 5. 架构约束



- **平台依赖**：本架构设计强依赖于运行在支持项目配额的 Linux 内核和 XFS 文件系统之上。
- **权限模型**：设计假定本工具的执行实体拥有足够的系统权限（`CAP_SYS_ADMIN`）来执行底层的配额和文件系统操作。
- **文件系统挂载**：设计生效的前提是目标 XFS 文件系统在挂载时已启用了项目配额 (`prjquota`) 选项。